<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Detector de Mascarillas</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
</head>
<body>
  <div class="container">
    <h1>Detector de Mascarillas üò∑</h1>
    <p>Env√≠a una imagen desde App Inventor para saber si usas la mascarilla correctamente.</p>

    <div class="preview">
      <img id="previewImage" src="" alt="Vista previa" style="max-width: 100%; height: auto;">
    </div>
    <button onclick="predict()">Detectar</button>

    <div id="result"></div>
  </div>

  <script>
    let model;

    window.onload = async () => {
      model = await tf.loadLayersModel("tfjs_model3/model.json");
      console.log("‚úÖ Modelo cargado");
    };

    // Recibir imagen base64 desde MIT App Inventor
    window.addEventListener("message", (event) => {
      const base64Image = event.data;
      const img = document.getElementById("previewImage");
      img.src = base64Image;
    });

    async function predict() {
      const img = document.getElementById("previewImage");
      if (!img.src.startsWith("data:image")) {
        document.getElementById("result").textContent = "‚ö†Ô∏è No se ha recibido una imagen v√°lida.";
        return;
      }

      const tensor = tf.browser.fromPixels(img)
        .resizeNearestNeighbor([150, 150]) // Cambia a [224, 224] si tu modelo lo requiere
        .toFloat()
        .div(255.0)
        .expandDims();

      const prediction = model.predict(tensor);
      const predArray = await prediction.array();
      const index = predArray[0].indexOf(Math.max(...predArray[0]));

      const etiquetas = ["Con mascarilla", "Mal puesta", "Sin mascarilla"];
      const colores = ["#28a745", "#ffc107", "#dc3545"];

      document.getElementById("result").textContent = `Resultado: ${etiquetas[index]}`;
      document.getElementById("result").style.color = colores[index];
    }
  </script>
</body>
</html>
